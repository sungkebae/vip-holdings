<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VIP PORTFOLIO | 성기배소장 전략</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
<style>
:root{--bg:#ffffff;--sf:#f5f6f8;--sf2:#ebedf2;--bd:#d8dbe5;--tx:#1a1d27;--ts:#6b7280;--ac:#2563eb;--gn:#059669;--rd:#dc2626;--gl:#d97706}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans KR',-apple-system,sans-serif;background:var(--bg);color:var(--tx);line-height:1.7;font-size:15px}
.ct{max-width:1200px;margin:0 auto;padding:20px 12px 80px}

.hd{text-align:center;margin-bottom:16px;padding:20px 0 12px}
.hb{display:inline-flex;align-items:center;gap:6px;background:rgba(220,38,38,.1);color:var(--rd);padding:5px 12px;border-radius:14px;font-size:13px;font-weight:600;margin-bottom:8px}
.hd h1{font-size:26px;font-weight:900;margin-bottom:2px}
.hd-sub{color:var(--ts);font-size:14px}

.update-bar{display:flex;justify-content:center;align-items:center;gap:8px;margin-bottom:14px;font-size:12px;color:var(--ts)}
.update-dot{width:7px;height:7px;border-radius:50%;background:#94a3b8;display:inline-block}

/* 상단 통계 */
.sm{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:14px}
.sc{background:var(--sf);border:1px solid var(--bd);border-radius:8px;padding:10px 6px;text-align:center}
.sc .lb{font-size:10px;color:var(--ts);font-weight:500;margin-bottom:1px}
.sc .vl{font-size:20px;font-weight:900}
.sc .sb{font-size:10px;color:var(--ts)}
.green{color:var(--gn)}.red{color:var(--rd)}.blue{color:var(--ac)}.gold{color:var(--gl)}

/* 탭 */
.tabs{display:flex;gap:0;margin-bottom:12px;border-bottom:2px solid var(--bd)}
.tab{padding:8px 16px;font-size:14px;font-weight:600;cursor:pointer;border-bottom:3px solid transparent;margin-bottom:-2px;color:var(--ts);transition:all .2s}
.tab.active{color:var(--rd);border-bottom-color:var(--rd)}
.tab .cnt{font-size:12px;font-weight:400;margin-left:3px}

/* 월별 필터 + 정렬 */
.ctrl{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap;align-items:center}
.fbtn{background:var(--sf);border:1px solid var(--bd);color:var(--ts);padding:5px 10px;border-radius:5px;font-size:12px;font-family:inherit;cursor:pointer;font-weight:500;transition:all .2s}
.fbtn:hover{border-color:var(--ac);color:var(--tx)}
.fbtn.active{background:var(--ac);border-color:var(--ac);color:white}
.sort-btn{background:white;border:1px solid var(--bd);color:var(--tx);padding:5px 10px;border-radius:5px;font-size:12px;font-family:inherit;cursor:pointer;font-weight:600;transition:all .2s}
.sort-btn:hover{background:var(--sf)}
.sort-btn.on{background:var(--rd);border-color:var(--rd);color:white}
.sep{width:1px;height:20px;background:var(--bd);margin:0 2px}

/* 월 구분 헤더 */
.month-row td{background:linear-gradient(135deg,#f0f4ff,#fef3f2);padding:8px 12px !important;border-bottom:2px solid var(--rd) !important}
.month-label{font-weight:900;font-size:15px;color:var(--rd)}
.month-stats{font-size:12px;color:var(--ts);margin-left:10px}
.month-top{font-size:12px;color:var(--gn);font-weight:600}

/* 테이블 */
.tw{border:1px solid var(--bd);border-radius:8px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.tsc{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;min-width:680px;table-layout:fixed}
colgroup col.c-date{width:42px}
colgroup col.c-name{width:120px}
colgroup col.c-ret{width:78px}
colgroup col.c-cur{width:70px}
colgroup col.c-buy{width:75px}
colgroup col.c-sell{width:100px}
colgroup col.c-wt{width:55px}
colgroup col.c-note{width:auto}
thead th{background:var(--sf);padding:8px 6px;font-size:11px;font-weight:700;color:var(--ts);border-bottom:2px solid var(--bd);white-space:nowrap;position:sticky;top:0;text-align:center;z-index:10}
thead th:nth-child(1){width:40px}
thead th:nth-child(2){width:auto}
thead th:nth-child(3){width:80px}
tbody td{padding:8px 6px;font-size:13px;text-align:center;border-bottom:1px solid var(--sf2);white-space:nowrap}
tbody tr:hover{background:rgba(220,38,38,.02)}

.sn{font-weight:800;color:var(--tx);font-size:14px}
.scode{font-size:10px;color:var(--ts);display:block;font-weight:400;line-height:1}
.dc{color:var(--ts);font-size:12px}
.buy-v{font-weight:600;color:var(--tx)}
.avg-note{font-size:10px;color:var(--ts);display:block}
.cur-v{font-weight:700;color:var(--gl)}
.sell-v{font-weight:600;color:var(--gn)}
.wt{font-size:11px;padding:2px 6px;border-radius:3px;background:rgba(37,99,235,.08);color:var(--ac);font-weight:600}
.nt{font-size:11px;color:var(--ts);max-width:140px;white-space:normal;word-break:keep-all;text-align:left;line-height:1.3}

.rb{display:inline-block;padding:3px 7px;border-radius:4px;font-weight:800;font-size:13px;min-width:58px;text-align:center}
.rb.pos{background:rgba(220,38,38,.08);color:var(--rd)}
.rb.neg{background:rgba(37,99,235,.08);color:var(--ac)}
.rb.neu{background:var(--sf);color:var(--ts)}

.no-data{text-align:center;padding:30px;color:var(--ts);font-size:13px}
.loading{text-align:center;padding:40px;color:var(--ts)}
.loading-spin{display:inline-block;width:22px;height:22px;border:3px solid var(--sf2);border-top-color:var(--rd);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

@media(max-width:768px){
.ct{padding:10px 6px 60px}
.hd{padding:14px 0 8px}
.hd h1{font-size:22px}
.sm{gap:4px}
.sc{padding:8px 4px}
.sc .vl{font-size:17px}
.sc .lb{font-size:9px}
table{min-width:580px}
thead th{padding:6px 4px;font-size:10px}
tbody td{padding:7px 4px;font-size:12px}
.sn{font-size:13px}
.rb{font-size:12px;min-width:50px;padding:2px 5px}
.nt{max-width:100px;font-size:10px}
.tab{padding:7px 12px;font-size:13px}
.month-label{font-size:13px}
.month-stats,.month-top{font-size:11px}
}
</style>
</head>
<body>
<div class="ct">

<div class="hd">
<div class="hb">VIP PORTFOLIO</div>
<h1>성기배소장 전략</h1>
<div class="hd-sub">단기스윙 시그널 · VIP 보유종목 현황</div>
</div>

<div class="update-bar">
<span class="update-dot" id="statusDot"></span>
<span id="updateTime">데이터 로딩 중...</span>
</div>

<div class="sm">
<div class="sc"><div class="lb">보유 종목</div><div class="vl blue" id="totalC">-</div><div class="sb" id="totalS">-</div><div class="sb" id="totalS2" style="color:var(--gn)"></div></div>
<div class="sc"><div class="lb">평균 수익률</div><div class="vl red" id="avgR">-</div><div class="sb" id="avgS">-</div></div>
<div class="sc"><div class="lb">수익/손실</div><div class="vl green" id="profC">-</div><div class="sb" id="profS">-</div></div>
<div class="sc"><div class="lb">최고 수익</div><div class="vl red" id="lossC">-</div><div class="sb" id="lossS">-</div></div>
</div>

<!-- 탭 -->
<div class="tabs">
<div class="tab active" id="tabActive" onclick="switchTab('active')">보유 중<span class="cnt" id="tabActiveC"></span></div>
<div class="tab" id="tabClosed" onclick="switchTab('closed')">이익실현<span class="cnt" id="tabClosedC"></span></div>
</div>

<!-- 월별 필터 + 정렬 -->
<div class="ctrl" id="ctrlBar">
<div id="filterBtns"></div>
<div class="sep"></div>
<button class="sort-btn" id="sortDate" onclick="toggleSort('date')">추천일 ▼</button>
<button class="sort-btn" id="sortReturn" onclick="toggleSort('return')">수익률 ▼</button>
</div>

<!-- 테이블 -->
<div class="tw"><div class="tsc">
<table>
<colgroup>
<col class="c-date">
<col class="c-name">
<col class="c-ret">
<col class="c-cur">
<col class="c-buy">
<col class="c-sell">
<col class="c-wt">
<col class="c-note">
</colgroup>
<thead><tr>
<th>추천일</th>
<th style="text-align:left;padding-right:0">종목명</th>
<th style="padding-left:0">수익률</th>
<th>현재가</th>
<th>매수가</th>
<th style="color:var(--gn)">매도목표</th>
<th>비중</th>
<th>비고</th>
</tr></thead>
<tbody id="tb">
<tr><td colspan="8" class="loading"><div class="loading-spin"></div><br>데이터를 불러오는 중...</td></tr>
</tbody>
</table>
</div></div>

</div>

<script>
var JSON_URL = './prices.json';
var DATA = null;
var currentTab = 'active';
var currentFilter = 'all';
var currentSort = 'date';
var sortAsc = false;

async function loadData() {
  try {
    var resp = await fetch(JSON_URL + '?t=' + Date.now());
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    DATA = await resp.json();
    renderAll();
  } catch (e) {
    console.error(e);
    document.getElementById('tb').innerHTML =
      '<tr><td colspan="8" class="no-data">데이터를 불러올 수 없습니다.</td></tr>';
  }
}

function renderAll() {
  if (!DATA) return;
  document.getElementById('statusDot').style.background = '#94a3b8';
  document.getElementById('updateTime').textContent = DATA.updated_at + ' 기준';

  var active = DATA.holdings.filter(function(h){ return h.is_active; });
  var closed = DATA.holdings.filter(function(h){ return !h.is_active; });
  document.getElementById('tabActiveC').textContent = '(' + active.length + ')';
  document.getElementById('tabClosedC').textContent = '(' + closed.length + ')';

  buildFilters();
  renderStats();
  renderTable();
}

function switchTab(tab) {
  currentTab = tab;
  currentFilter = 'all';
  document.getElementById('tabActive').className = tab === 'active' ? 'tab active' : 'tab';
  document.getElementById('tabClosed').className = tab === 'closed' ? 'tab active' : 'tab';
  buildFilters();
  renderStats();
  renderTable();
}

// ── 필터 ──
function buildFilters() {
  var items = getTabItems();
  var months = {};
  items.forEach(function(h) {
    if (h.rec_date) {
      var m = h.rec_date.substring(0, 7);
      months[m] = (months[m] || 0) + 1;
    }
  });

  var sorted = Object.keys(months).sort().reverse();
  var total = items.length;
  var html = '<button class="fbtn ' + (currentFilter === 'all' ? 'active' : '') +
    '" onclick="setFilter(\'all\')">전체 ' + total + '</button>';
  sorted.forEach(function(m) {
    var parts = m.split('-');
    var label = parts[0].substring(2) + '년 ' + parseInt(parts[1]) + '월';
    html += '<button class="fbtn ' + (currentFilter === m ? 'active' : '') +
      '" onclick="setFilter(\'' + m + '\')">' + label + '</button>';
  });

  document.getElementById('filterBtns').innerHTML = html;
}

function setFilter(f) {
  currentFilter = f;
  buildFilters();
  renderStats();
  renderTable();
}

function getTabItems() {
  if (!DATA) return [];
  return DATA.holdings.filter(function(h) {
    return currentTab === 'active' ? h.is_active : !h.is_active;
  });
}

function getFilteredItems() {
  var items = getTabItems();
  if (currentFilter !== 'all') {
    items = items.filter(function(h) { return h.rec_date.startsWith(currentFilter); });
  }
  return items;
}

// ── 정렬 ──
function toggleSort(type) {
  if (currentSort === type) {
    sortAsc = !sortAsc;
  } else {
    currentSort = type;
    sortAsc = false;
  }
  document.getElementById('sortDate').className = 'sort-btn' + (currentSort === 'date' ? ' on' : '');
  document.getElementById('sortReturn').className = 'sort-btn' + (currentSort === 'return' ? ' on' : '');
  document.getElementById('sortDate').textContent = '추천일' + (currentSort === 'date' ? (sortAsc ? ' ▲' : ' ▼') : '');
  document.getElementById('sortReturn').textContent = '수익률' + (currentSort === 'return' ? (sortAsc ? ' ▲' : ' ▼') : '');
  renderTable();
}

function sortItems(items) {
  var sorted = items.slice();
  if (currentSort === 'date') {
    sorted.sort(function(a, b) {
      return sortAsc ? (a.rec_date > b.rec_date ? 1 : -1) : (a.rec_date < b.rec_date ? 1 : -1);
    });
  } else {
    sorted.sort(function(a, b) {
      var ba = a.buy_price || 0, ca = a.cur_price || 0;
      var bb = b.buy_price || 0, cb = b.cur_price || 0;
      var ra = (ba > 0 && ca > 0) ? (ca - ba) / ba : -9999;
      var rb = (bb > 0 && cb > 0) ? (cb - bb) / bb : -9999;
      return sortAsc ? ra - rb : rb - ra;
    });
  }
  return sorted;
}

// ── 통계 ──
function renderStats() {
  var items = getFilteredItems();
  var tt = 0, cnt = 0, pf = 0, ls = 0, mx = -Infinity, mxN = '';

  items.forEach(function(h) {
    var buy = h.buy_price || 0;
    var cur = h.cur_price || 0;
    if (buy > 0 && cur > 0) {
      var r = Math.round((cur - buy) / buy * 10000) / 100;
      tt += r;
      cnt++;
      if (r > 0) pf++;
      if (r < 0) ls++;
      if (r > mx) { mx = r; mxN = h.name; }
    }
  });

  document.getElementById('totalC').textContent = items.length + '종목';
  document.getElementById('totalS').textContent = currentTab === 'active' ? '보유 중' : '이익실현';
  
  // 일부이익실현 (매도목표가 있는 종목)
  if (currentTab === 'active') {
    var partial = items.filter(function(h) { return h.sell_target && h.sell_target.length > 0; }).length;
    document.getElementById('totalS2').textContent = partial > 0 ? '일부익절 ' + partial + '종목' : '';
  } else {
    document.getElementById('totalS2').textContent = '';
  }

  if (cnt > 0) {
    var av = (tt / cnt).toFixed(2);
    document.getElementById('avgR').textContent = (av >= 0 ? '+' : '') + av + '%';
    document.getElementById('avgR').className = 'vl ' + (av >= 0 ? 'red' : 'blue');
    document.getElementById('avgS').textContent = cnt + '종목 기준';
    document.getElementById('profC').textContent = pf + ' / ' + ls;
    document.getElementById('profS').textContent = '승률 ' + (pf / cnt * 100).toFixed(0) + '%';
    if (mx > -Infinity) {
      document.getElementById('lossC').textContent = '+' + mx.toFixed(2) + '%';
      document.getElementById('lossS').textContent = mxN;
    }
  } else {
    document.getElementById('avgR').textContent = '-';
    document.getElementById('avgS').textContent = '';
    document.getElementById('profC').textContent = '-';
    document.getElementById('profS').textContent = '';
    document.getElementById('lossC').textContent = '-';
    document.getElementById('lossS').textContent = '';
  }
}

// ── 월별 통계 계산 ──
function getMonthStats(items, month) {
  var mi = items.filter(function(h) { return h.rec_date && h.rec_date.startsWith(month); });
  var cnt = 0, pf = 0, top = [];
  mi.forEach(function(h) {
    var buy = h.buy_price || 0;
    var cur = h.cur_price || 0;
    if (buy > 0 && cur > 0) {
      var r = Math.round((cur - buy) / buy * 10000) / 100;
      cnt++;
      if (r > 0) pf++;
      top.push({ name: h.name, ret: r });
    }
  });
  top.sort(function(a, b) { return b.ret - a.ret; });
  var top3 = top.slice(0, 3);

  var wr = cnt > 0 ? (pf / cnt * 100).toFixed(0) : 0;
  var best = top3.length > 0 ? '+' + top3[0].ret.toFixed(1) + '%' : '-';
  var names = top3.map(function(t) { return t.name + '(' + (t.ret >= 0 ? '+' : '') + t.ret.toFixed(1) + '%)'; }).join(' · ');

  return {
    count: mi.length,
    winRate: wr,
    best: best,
    topNames: names
  };
}

// ── 테이블 ──
function renderTable() {
  var items = getFilteredItems();
  items = sortItems(items);

  if (items.length === 0) {
    document.getElementById('tb').innerHTML =
      '<tr><td colspan="8" class="no-data">해당 조건의 종목이 없습니다.</td></tr>';
    return;
  }

  var html = '';
  var lastMonth = '';
  var allItems = getTabItems(); // 월별 통계용

  items.forEach(function(h) {
    // 월 구분 헤더 (날짜 정렬일 때만)
    if (currentSort === 'date' && h.rec_date) {
      var m = h.rec_date.substring(0, 7);
      if (m !== lastMonth && currentFilter === 'all') {
        lastMonth = m;
        var parts = m.split('-');
        var mLabel = parts[0] + '년 ' + parseInt(parts[1]) + '월';
        var ms = getMonthStats(allItems, m);
        html += '<tr class="month-row"><td colspan="8">' +
          '<span class="month-label">' + mLabel + '</span>' +
          '<span class="month-stats">' + ms.count + '종목 · 승률 ' + ms.winRate + '% · 최고 ' + ms.best + '</span>' +
          '<br><span class="month-top">' + ms.topNames + '</span>' +
          '</td></tr>';
      }
    }

    var buy = h.buy_price || 0;
    var add = h.add_buy || 0;
    var avg = h.avg_price || 0;
    var cur = h.cur_price || 0;

    var buyH = '';
    if (buy > 0) {
      buyH = '<span class="buy-v">' + buy.toLocaleString() + '</span>';
    } else {
      buyH = '<span style="color:var(--ts)">-</span>';
    }

    var curH = cur > 0 ? '<span class="cur-v">' + cur.toLocaleString() + '</span>' : '<span style="color:var(--ts)">-</span>';

    var retH = '<span class="rb neu">-</span>';
    if (buy > 0 && cur > 0) {
      var r = Math.round((cur - buy) / buy * 10000) / 100;
      retH = '<span class="rb ' + (r >= 0 ? 'pos' : 'neg') + '">' + (r >= 0 ? '+' : '') + r.toFixed(2) + '%</span>';
    }

    var dayH = '';
    if (h.rec_date && h.rec_date.length >= 10) {
      dayH = '<span class="dc">' + parseInt(h.rec_date.substring(8, 10)) + '일</span>';
    }

    var sellH = h.sell_target ? '<span class="sell-v">' + h.sell_target + '</span>' : '<span style="color:var(--ts)">-</span>';
    var wtH = h.weight ? '<span class="wt">' + h.weight + '</span>' : '-';

    // ── 비고란 색상 처리 ──
    var noteH = '';
    if (h.note) {
      if (h.note.indexOf('손절') >= 0) {
        noteH = '<span class="nt" style="color:var(--ac);font-weight:900">' + h.note + '</span>';
      } else {
        noteH = '<span class="nt" style="color:var(--rd);font-weight:900">' + h.note + '</span>';
      }
    } else {
      noteH = '<span style="color:var(--ts)">-</span>';
    }

    html += '<tr>' +
      '<td>' + dayH + '</td>' +
      '<td style="text-align:left;padding-right:0"><span class="sn">' + h.name + '</span><span class="scode">' + h.code + '</span></td>' +
      '<td style="padding-left:0">' + retH + '</td>' +
      '<td>' + curH + '</td>' +
      '<td>' + buyH + '</td>' +
      '<td>' + sellH + '</td>' +
      '<td>' + wtH + '</td>' +
      '<td>' + noteH + '</td>' +
      '</tr>';
  });

  document.getElementById('tb').innerHTML = html;
}

loadData();
</script>
</body>
</html>
